<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement - BDB Billetterie</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Finalisez votre achat de ticket d'√©v√©nement √©tudiant avec BDB. Paiement s√©curis√© par Stripe.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/Asset/favicon.png">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Styles sp√©cifiques au paiement -->
    <style>
        .payment-container {
            max-width: 780px;
            margin: 120px auto 60px;
            padding: 0 2rem;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .payment-header h1 {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        .payment-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .payment-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(218,252,59,0.1);
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .event-summary,
        .payment-form {
            background: transparent;
            padding: 0;
            border: none;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .event-summary {
            gap: 1rem;
        }

        .event-summary h3 {
            color: var(--accent-color);
            font-size: 1.25rem;
            margin: 0;
        }

        .event-image {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .event-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .event-details {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .event-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        .share-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .share-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-color);
            border-color: rgba(218, 252, 59, 0.3);
        }

        .share-button i {
            font-size: 0.9rem;
        }

        .payment-form h3 {
            color: var(--accent-color);
            font-size: 1.25rem;
            margin: 0;
        }

        .form-group {
            margin: 0;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        #payment-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(218,252,59,0.25);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.08);
        }

        .help-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
            display: block;
        }

        .rgpd-consent {
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(218, 252, 59, 0.1);
        }

        .rgpd-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .rgpd-checkbox input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(218, 252, 59, 0.5);
            border-radius: 4px;
            background: transparent;
            position: relative;
            flex-shrink: 0;
            transition: var(--transition);
            margin-top: 2px;
        }

        .rgpd-checkbox input[type="checkbox"]:checked + .checkmark {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .rgpd-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--background-color);
            font-size: 12px;
            font-weight: bold;
        }

        .rgpd-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .rgpd-link {
            color: var(--accent-color);
            text-decoration: none;
            transition: var(--transition);
        }

        .rgpd-link:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-container input {
            padding-right: 50px;
            flex: 1;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.3s ease;
            z-index: 10;
        }

        .toggle-password:hover {
            color: var(--accent-color);
        }

        .password-strength {
            margin-top: 10px;
        }

        .strength-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .strength-fill.weak { width: 25%; background: #ff4757; }
        .strength-fill.fair { width: 50%; background: #ffa502; }
        .strength-fill.good { width: 75%; background: #2ed573; }
        .strength-fill.strong { width: 100%; background: #7bed9f; }

        .strength-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .password-requirements {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .requirement {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin: 3px 0;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .requirement.valid {
            color: #2ed573;
        }

        .requirement.invalid {
            color: #ff4757;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quantity-selector label {
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .quantity-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--accent-color);
            background: transparent;
            color: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background: var(--accent-color);
            color: var(--background-color);
        }

        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quantity-input {
            width: 52px;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
        }

        .price-breakdown {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 1.25rem;
        }

        .price-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 0.95rem;
        }

        .price-line.total {
            border-top: 1px solid rgba(218,252,59,0.2);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            font-weight: bold;
            font-size: 1rem;
        }

        .pay-button {
            width: 100%;
            padding: 1rem;
            background: transparent;
            border: 2px solid var(--accent-color);
            border-radius: 24px;
            color: var(--text-color);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .pay-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--accent-color);
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.3s ease-out;
            z-index: 0;
        }

        .pay-button:hover::before {
            transform: scaleX(1);
            transform-origin: left;
        }

        .pay-button span {
            position: relative;
            z-index: 1;
        }

        .pay-button:hover span {
            color: var(--background-color);
        }

        .pay-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid var(--text-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #ff6b6b;
            display: none;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #4CAF50;
            display: none;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-color);
            text-decoration: none;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .back-button:hover {
            color: var(--text-color);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        .notification.success {
            background-color: #4CAF50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .notification.error {
            background-color: #f44336;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .ticket-type-section {
            display: none;
            margin-bottom: 1.5rem;
            gap: 0.75rem;
        }

        .ticket-type-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .ticket-type-card {
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.04);
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .ticket-type-card.selected {
            border-color: var(--primary-color);
            background: rgba(76, 175, 80, 0.12);
        }

        .ticket-type-card.disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .ticket-type-card input[type="radio"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
        }

        .ticket-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .ticket-type-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .ticket-type-price {
            font-weight: 600;
            color: var(--primary-color);
        }

        .ticket-type-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .ticket-type-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .field-error {
            color: #f44336;
            font-size: 0.85rem;
            margin: 0;
        }

        .quantity-hint {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            min-height: 1.25rem;
        }

        .selected-ticket-summary {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.06);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .selected-ticket-summary .label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.6);
        }

        .selected-ticket-summary .value {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .payment-card {
                grid-template-columns: 1fr;
                padding: 1.5rem;
                gap: 1.25rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .payment-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <div>
                <a href="index.html" class="brand-link">
                    <img src="Asset/Babylone 1024x1024.png" alt="BDB Logo" class="logo">
                    <span class="brand-name">BDB</span>
                </a>
            </div>
            <button class="hamburger-menu" aria-label="Menu" aria-expanded="false" aria-controls="nav-links">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links" id="nav-links" role="navigation" aria-label="Menu principal">
                <a href="index.html">Accueil</a>
                <a href="billetterie.html">Billetterie</a>
                <a href="index.html#contact">Contact</a>
            </div>
            <a href="connexion.html" class="account-link" title="Mon compte">
                <i class="fas fa-user"></i>
            </a>
        </div>
    </nav>

    <main class="payment-container">
        <a href="billetterie.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Retour aux √©v√©nements
        </a>

        <div class="payment-header">
            <h1>Finaliser votre achat</h1>
            <p>Remplissez vos informations pour recevoir votre ticket</p>
        </div>

        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <div class="payment-card">
            <!-- R√©sum√© de l'√©v√©nement -->
            <div class="event-summary">
                <h3>R√©sum√© de votre commande</h3>
                <div id="event-summary-content">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
            </div>

            <!-- Formulaire de paiement -->
            <div class="payment-form">
                <h3>Informations de paiement</h3>
                <form id="payment-form">
                    <div class="form-group ticket-type-section" id="ticket-type-section">
                        <label for="ticketType">Type de billet <span aria-hidden="true">*</span></label>
                        <div id="ticket-type-options" class="ticket-type-list"></div>
                        <p id="ticket-type-error" class="field-error"></p>
                    </div>

                    <div class="quantity-selector">
                        <label>Quantit√© :</label>
                        <button type="button" class="quantity-btn" id="decrease-qty">-</button>
                        <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="10" readonly>
                        <button type="button" class="quantity-btn" id="increase-qty">+</button>
                    </div>
                    <p id="quantity-hint" class="quantity-hint"></p>

                    <div class="form-group">
                        <label for="firstName">Pr√©nom *</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>

                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">T√©l√©phone</label>
                        <input type="tel" id="phone" name="phone">
                    </div>

                    <div class="form-group">
                        <label for="password">Mot de passe *</label>
                        <div class="password-container">
                            <input type="password" id="password" name="password" required placeholder="Cr√©ez votre mot de passe BDB">
                            <button type="button" class="toggle-password" id="toggle-password" onclick="togglePasswordVisibility()">
                                <span id="password-icon">üëÅÔ∏è</span>
                            </button>
                        </div>
                        <div class="password-strength" id="password-strength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="strength-fill"></div>
                            </div>
                            <div class="strength-text" id="strength-text">Force du mot de passe</div>
                        </div>
                        <small class="help-text">Un compte BDB sera cr√©√© avec vos informations pour g√©rer vos tickets</small>
                    </div>

                    <div class="price-breakdown" id="price-breakdown">
                        <!-- Contenu g√©n√©r√© dynamiquement -->
                    </div>

                    <div class="rgpd-consent">
                        <label class="rgpd-checkbox">
                            <input type="checkbox" id="rgpd-consent" required>
                            <span class="checkmark"></span>
                            <span class="rgpd-text">
                                J'accepte la <a href="conditions-utilisation.html" target="_blank" class="rgpd-link">politique de confidentialit√©</a> 
                                et les <a href="conditions-utilisation.html" target="_blank" class="rgpd-link">conditions d'utilisation</a> de BDB
                            </span>
                        </label>
                    </div>

                    <button type="submit" class="pay-button" id="pay-button">
                        <div class="loading-spinner" id="loading-spinner"></div>
                        <span id="pay-button-text">Payer maintenant</span>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="legal-links">
                <a href="politique-confidentialite.html" target="_blank">Politique de confidentialit√©</a>
                <a href="conditions-utilisation.html" target="_blank">Conditions d'utilisation</a>
            </div>
        </div>
        <p class="copyright">¬© 2024 BDB. Tous droits r√©serv√©s.</p>
    </footer>

    <div id="notification" class="notification"></div>

    <script>
        // Variables globales
        let eventData = null;
        let quantity = 1;
        let stripe = null;
        let elements = null;
        let ticketTypes = [];
        let selectedTicketTypeId = null;

        // Initialiser Stripe
        function initStripe() {
            stripe = Stripe('pk_live_51HLuKAAqjNmyAK5H83YcEqRZO4110oYLbUEQ0oDdfq7ptRQh48imbJ34aXhcxzyySLaSffMYGE1MRnSAvRH62AWO0023V6P7bR');
        }

        // Fonction pour afficher les notifications
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            notification.offsetHeight;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Fonction pour afficher les erreurs
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Fonction pour charger les donn√©es de l'√©v√©nement
        async function loadEventData() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');

            if (!eventId) {
                showError('ID d\'√©v√©nement manquant');
                return;
            }

            try {
                const response = await fetch(`/.netlify/functions/getEvent?id=${eventId}`);
                const data = await response.json();

                if (response.ok) {
                    eventData = data.event;
                    ticketTypes = normaliseTicketTypes(data.event.ticket_types || data.ticket_types || []);
                    autoSelectTicketType();
                    ensureQuantityWithinBounds();
                    displayEventSummary();
                    renderTicketTypeOptions();
                    updateQuantityUI();
                    updatePriceBreakdown();
                    updatePayButtonState();
                } else {
                    throw new Error(data.error || 'Erreur lors du chargement de l\'√©v√©nement');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur lors du chargement de l\'√©v√©nement');
            }
        }

        function formatEventDate(dateString) {
            if (!dateString) return '';
            try {
                return new Intl.DateTimeFormat('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(new Date(dateString));
            } catch (error) {
                return dateString;
            }
        }

        function getBasePriceLabel() {
            if (ticketTypes.length === 1) {
                const price = Number(ticketTypes[0].price);
                return Number.isFinite(price) ? `Billet : ${formatPrice(price)}` : 'Tarif indisponible';
            }
            if (ticketTypes.length > 1) {
                const prices = ticketTypes
                    .map((type) => Number(type.price))
                    .filter((price) => Number.isFinite(price) && price >= 0);
                if (prices.length) {
                    const lowest = Math.min(...prices);
                    return `√Ä partir de ${formatPrice(lowest)}`;
                }
                return 'Tarifs variables';
            }
            const price = Number(eventData?.price);
            return Number.isFinite(price) ? `Billet : ${formatPrice(price)}` : 'Tarif indisponible';
        }

        function displayEventSummary() {
            if (!eventData) return;

            const summaryContent = document.getElementById('event-summary-content');
            summaryContent.innerHTML = `
                <div class="event-image" style="background-image: url('${eventData.image_url || 'Asset/EventPhare 01.png'}')"></div>
                <h4 class="event-title">${eventData.name}</h4>
                <div class="event-details">
                    <div class="event-detail">
                        <i class="fas fa-calendar-alt"></i>
                        <span>${formatEventDate(eventData.date)}</span>
                    </div>
                    <div class="event-detail">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${eventData.location || ''}</span>
                    </div>
                    <div class="event-detail">
                        <i class="fas fa-users"></i>
                        <span>${eventData.association_name || 'Association'}</span>
                    </div>
                </div>
                <div class="event-price">${getBasePriceLabel()}</div>
                <div class="selected-ticket-summary">
                    <span class="label">Billet s√©lectionn√©</span>
                    <span class="value" id="selected-ticket-summary">${formatSelectedTicketSummary()}</span>
                </div>
                <button class="share-button" onclick="shareEvent()">
                    <i class="fas fa-share-alt"></i>
                    Partager
                </button>
            `;
        }

        function shareEvent() {
            if (!eventData) return;

            const shareUrl = window.location.href;
            const shareText = `${eventData.name} ‚Ä¢ ${getBasePriceLabel()}`;

            if (navigator.share) {
                navigator.share({
                    title: eventData.name,
                    text: shareText,
                    url: shareUrl
                }).catch(err => console.log('Erreur partage:', err));
            } else {
                navigator.clipboard.writeText(`${shareText} - ${shareUrl}`).then(() => {
                    showNotification('Lien copi√© dans le presse-papier !', 'success');
                }).catch(() => {
                    showNotification(`Lien √† partager : ${shareUrl}`, 'success');
                });
            }
        }

        function parseNullableInt(value) {
            if (value === null || value === undefined) {
                return null;
            }
            const parsed = parseInt(value, 10);
            return Number.isFinite(parsed) ? parsed : null;
        }

        function normaliseTicketTypes(types) {
            if (!Array.isArray(types)) return [];

            return types
                .map((type) => {
                    const price = parseFloat(type.price ?? type.amount ?? 0);
                    return {
                        id: type.id,
                        name: type.name || 'Billet',
                        description: type.description || '',
                        price: Number.isFinite(price) ? price : 0,
                        quantity_limit: parseNullableInt(type.quantity_limit),
                        remaining_quantity: parseNullableInt(
                            type.remaining_quantity ??
                            type.quantity_remaining ??
                            type.available_quantity ??
                            type.stock_remaining ??
                            type.stock
                        )
                    };
                })
                .filter((type) => type.id);
        }

        function autoSelectTicketType() {
            if (!ticketTypes.length) {
                selectedTicketTypeId = null;
                return;
            }

            if (selectedTicketTypeId && ticketTypes.some((type) => type.id === selectedTicketTypeId)) {
                const selectedType = getSelectedTicketType();
                if (selectedType && getRemainingForType(selectedType) !== 0) {
                    return;
                }
            }

            if (ticketTypes.length === 1) {
                const soleType = ticketTypes[0];
                if (getRemainingForType(soleType) !== 0) {
                    selectedTicketTypeId = soleType.id;
                }
            } else {
                selectedTicketTypeId = null;
            }
        }

        function renderTicketTypeOptions() {
            const section = document.getElementById('ticket-type-section');
            const container = document.getElementById('ticket-type-options');
            const error = document.getElementById('ticket-type-error');

            if (!section || !container || !error) return;

            if (!ticketTypes.length) {
                section.style.display = 'none';
                error.textContent = '';
                return;
            }

            section.style.display = 'flex';
            section.style.flexDirection = 'column';
            container.innerHTML = '';

            ticketTypes.forEach((type) => {
                const card = document.createElement('label');
                card.className = 'ticket-type-card';

                const remaining = getRemainingForType(type);
                const soldOut = remaining !== null && remaining <= 0;

                if (selectedTicketTypeId === type.id) {
                    card.classList.add('selected');
                }
                if (soldOut) {
                    card.classList.add('disabled');
                }

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'ticketType';
                radio.value = type.id;
                radio.checked = selectedTicketTypeId === type.id;
                radio.disabled = soldOut;
                card.appendChild(radio);

                const header = document.createElement('div');
                header.className = 'ticket-type-header';

                const name = document.createElement('span');
                name.className = 'ticket-type-name';
                name.textContent = type.name;

                const price = document.createElement('span');
                price.className = 'ticket-type-price';
                price.textContent = formatPrice(type.price);

                header.appendChild(name);
                header.appendChild(price);

                const meta = document.createElement('div');
                meta.className = 'ticket-type-meta';

                if (soldOut) {
                    meta.appendChild(createMetaBadge('Complet'));
                } else if (remaining === null) {
                    meta.appendChild(createMetaBadge('Disponible'));
                } else {
                    meta.appendChild(createMetaBadge(`${remaining} restant${remaining > 1 ? 's' : ''}`));
                }

                if (type.quantity_limit !== null) {
                    meta.appendChild(createMetaBadge(`Limite ${type.quantity_limit} / commande`));
                }

                card.appendChild(header);
                card.appendChild(meta);

                if (type.description) {
                    const description = document.createElement('span');
                    description.className = 'ticket-type-description';
                    description.textContent = type.description;
                    card.appendChild(description);
                }

                card.addEventListener('click', (event) => {
                    if (soldOut) return;
                    if (event.target.tagName !== 'INPUT') {
                        radio.checked = true;
                    }
                    handleTicketTypeSelection(type.id);
                });

                radio.addEventListener('change', () => handleTicketTypeSelection(type.id));

                container.appendChild(card);
            });
        }

        function createMetaBadge(text) {
            const pill = document.createElement('span');
            pill.textContent = text;
            return pill;
        }

        function handleTicketTypeSelection(typeId) {
            selectedTicketTypeId = typeId;
            const error = document.getElementById('ticket-type-error');
            if (error) {
                error.textContent = '';
            }
            renderTicketTypeOptions();
            ensureQuantityWithinBounds();
            updateQuantityUI();
            updatePriceBreakdown();
            updateSelectedTicketSummary();
            updatePayButtonState();
        }

        function getSelectedTicketType() {
            return ticketTypes.find((type) => type.id === selectedTicketTypeId) || null;
        }

        function getRemainingForType(type) {
            if (!type) return null;
            if (type.remaining_quantity === null || type.remaining_quantity === undefined) {
                return null;
            }
            return type.remaining_quantity;
        }

        function formatPrice(amount) {
            if (!Number.isFinite(amount)) {
                return '0,00¬†‚Ç¨';
            }
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function formatSelectedTicketSummary() {
            const selectedType = getSelectedTicketType();
            const unitPrice = getUnitPrice();
            const qty = Number.isFinite(quantity) ? quantity : 0;

            if (unitPrice === null) {
                return 'S√©lectionnez un type de billet';
            }

            if (!Number.isFinite(unitPrice) || qty <= 0) {
                return 'Billets indisponibles';
            }

            const label = selectedType ? selectedType.name : 'Billet';
            if (qty > 1) {
                const total = unitPrice * qty;
                return `${label} ‚Ä¢ ${qty} √ó ${formatPrice(unitPrice)} = ${formatPrice(total)}`;
            }

            return `${label} ‚Ä¢ ${formatPrice(unitPrice)}`;
        }

        function updateSelectedTicketSummary() {
            const summaryElement = document.getElementById('selected-ticket-summary');
            if (!summaryElement) return;
            summaryElement.textContent = formatSelectedTicketSummary();
        }

        function getUnitPrice() {
            const selectedType = getSelectedTicketType();
            if (selectedType) {
                return Number(selectedType.price) || 0;
            }
            if (ticketTypes.length > 0) {
                return null;
            }
            return Number(eventData?.price) || 0;
        }

        function ensureQuantityWithinBounds() {
            const maxQuantity = getMaxAvailableQuantity();
            if (maxQuantity === 0) {
                quantity = 0;
                return;
            }
            if (quantity < 1) {
                quantity = 1;
            }
            if (Number.isFinite(maxQuantity) && maxQuantity > 0) {
                quantity = Math.min(quantity, maxQuantity);
            }
        }

        function getMaxAvailableQuantity() {
            let max = Infinity;

            const selectedType = getSelectedTicketType();
            if (selectedType) {
                const remaining = getRemainingForType(selectedType);
                if (remaining !== null) {
                    max = Math.min(max, Math.max(remaining, 0));
                }
                if (selectedType.quantity_limit !== null) {
                    max = Math.min(max, Math.max(selectedType.quantity_limit, 0));
                }
            }

            const eventAvailable = parseNullableInt(eventData?.available_tickets);
            if (eventAvailable !== null) {
                max = Math.min(max, Math.max(eventAvailable, 0));
            }

            if (!Number.isFinite(max)) {
                max = 10;
            }

            return Math.max(0, Math.floor(max));
        }

        function updateQuantityUI() {
            const quantityInput = document.getElementById('quantity');
            const decreaseBtn = document.getElementById('decrease-qty');
            const increaseBtn = document.getElementById('increase-qty');
            const hint = document.getElementById('quantity-hint');

            if (!quantityInput || !decreaseBtn || !increaseBtn || !hint) return;

            const maxQuantity = getMaxAvailableQuantity();

            if (maxQuantity === 0) {
                quantityInput.value = 0;
                decreaseBtn.disabled = true;
                increaseBtn.disabled = true;
                hint.textContent = 'Ce type de billet est complet.';
                return;
            }

            if (quantity === 0) {
                quantity = 1;
            }

            quantityInput.value = quantity;
            decreaseBtn.disabled = quantity <= 1;
            increaseBtn.disabled = quantity >= maxQuantity;

            const selectedType = getSelectedTicketType();
            if (ticketTypes.length > 0 && !selectedType) {
                hint.textContent = 'S√©lectionnez un type de billet pour voir les disponibilit√©s.';
                return;
            }

            const remaining = selectedType ? getRemainingForType(selectedType) : parseNullableInt(eventData?.available_tickets);
            const limit = selectedType?.quantity_limit;
            const hints = [];

            if (Number.isFinite(remaining)) {
                hints.push(`${remaining} billet${remaining > 1 ? 's' : ''} restant${remaining > 1 ? 's' : ''}`);
            }
            if (Number.isFinite(limit)) {
                hints.push(`Maximum ${limit} par commande`);
            }

            hint.textContent = hints.join(' ‚Ä¢ ');
        }

        function updatePriceBreakdown() {
            if (!eventData) return;

            const breakdown = document.getElementById('price-breakdown');
            if (!breakdown) return;

            const unitPrice = getUnitPrice();
            if (unitPrice === null) {
                breakdown.innerHTML = '<div class="price-line"><span>S√©lectionnez un type de billet pour afficher le montant.</span><span></span></div>';
                updatePayButtonLabel(null);
                updateSelectedTicketSummary();
                return;
            }

            const qty = quantity || 0;
            const baseAmount = unitPrice * qty;
            const feePercentage = Number(eventData?.platform_fee_percentage ?? eventData?.platform_fee ?? 5);
            const feeAmount = baseAmount * (feePercentage / 100);
            const totalAmount = baseAmount + feeAmount;

            if (qty === 0) {
                breakdown.innerHTML = '<div class="price-line"><span>Ce billet n\'est plus disponible.</span><span></span></div>';
                updatePayButtonLabel(0);
                updateSelectedTicketSummary();
                return;
            }

            const selectedType = getSelectedTicketType();
            const ticketLabel = selectedType ? `${selectedType.name} (${qty} √ó ${formatPrice(unitPrice)})` : `Billet (${qty} √ó ${formatPrice(unitPrice)})`;

            breakdown.innerHTML = `
                <div class="price-line">
                    <span>${ticketLabel}</span>
                    <span>${formatPrice(baseAmount)}</span>
                </div>
                <div class="price-line">
                    <span>Frais de service (${feePercentage.toFixed(2).replace(/\.00$/, '')}%)</span>
                    <span>${formatPrice(feeAmount)}</span>
                </div>
                <div class="price-line total">
                    <span>Total</span>
                    <span>${formatPrice(totalAmount)}</span>
                </div>
            `;

            updatePayButtonLabel(totalAmount);
            updateSelectedTicketSummary();
        }

        function updatePayButtonLabel(amount) {
            const label = document.getElementById('pay-button-text');
            if (!label) return;

            if (amount === null) {
                label.textContent = 'S√©lectionnez un type de billet';
            } else if (!Number.isFinite(amount) || amount <= 0) {
                label.textContent = 'Indisponible';
            } else {
                label.textContent = `Payer ${formatPrice(amount)}`;
            }
        }

        function updatePayButtonState() {
            const button = document.getElementById('pay-button');
            if (!button) return;

            const consentGiven = document.getElementById('rgpd-consent')?.checked ?? false;
            const hasEvent = Boolean(eventData);
            const quantityAvailable = getMaxAvailableQuantity();
            const hasValidQuantity = quantity > 0 && quantityAvailable > 0;
            const ticketSelected = ticketTypes.length === 0 || Boolean(selectedTicketTypeId);

            button.disabled = !(hasEvent && consentGiven && hasValidQuantity && ticketSelected);
        }

        function changeQuantity(newValue) {
            if (!eventData) return;
            if (!Number.isFinite(newValue)) return;
            quantity = Math.floor(Math.max(newValue, 0));
            ensureQuantityWithinBounds();
            updateQuantityUI();
            updatePriceBreakdown();
            updatePayButtonState();
        }

        document.getElementById('decrease-qty').addEventListener('click', () => {
            changeQuantity(quantity - 1);
        });

        document.getElementById('increase-qty').addEventListener('click', () => {
            changeQuantity(quantity + 1);
        });

        document.getElementById('rgpd-consent').addEventListener('change', updatePayButtonState);

        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!eventData) {
                showError('Donn√©es de l\'√©v√©nement manquantes');
                return;
            }

            if (ticketTypes.length > 0 && !selectedTicketTypeId) {
                const error = document.getElementById('ticket-type-error');
                if (error) {
                    error.textContent = 'Veuillez s√©lectionner un type de billet pour continuer.';
                }
                showError('S√©lectionnez un type de billet pour poursuivre le paiement.');
                return;
            }

            if (getMaxAvailableQuantity() === 0) {
                showError('Ce type de billet n\'est plus disponible.');
                return;
            }

            const formData = new FormData(e.target);
            const customerInfo = {
                firstName: (formData.get('firstName') || '').trim(),
                lastName: (formData.get('lastName') || '').trim(),
                email: (formData.get('email') || '').trim(),
                phone: (formData.get('phone') || '').trim(),
                password: formData.get('password')
            };

            if (!customerInfo.firstName || !customerInfo.lastName || !customerInfo.email || !customerInfo.password) {
                showError('Veuillez remplir tous les champs obligatoires');
                return;
            }

            if (!isPasswordValid(customerInfo.password)) {
                showError('Le mot de passe ne respecte pas tous les crit√®res de s√©curit√©');
                return;
            }

            const rgpdConsent = document.getElementById('rgpd-consent');
            if (!rgpdConsent.checked) {
                showError('Vous devez accepter la politique de confidentialit√© et les conditions d\'utilisation');
                return;
            }

            const payButton = document.getElementById('pay-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const payButtonText = document.getElementById('pay-button-text');

            payButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            payButtonText.textContent = 'Traitement...';

            try {
                const response = await fetch('/.netlify/functions/createWebPaymentIntent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_id: eventData.id,
                        quantity: quantity,
                        customerInfo: customerInfo,
                        association_id: eventData.association_id,
                        ticket_type_id: selectedTicketTypeId || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
                    if (error) {
                        throw new Error(error.message);
                    }
                } else {
                    throw new Error(data.error || 'Erreur lors de la cr√©ation du paiement');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError(error.message || 'Erreur lors du traitement du paiement');
            } finally {
                loadingSpinner.style.display = 'none';
                updatePriceBreakdown();
                updatePayButtonState();
            }
        });

        // Menu hamburger
        const hamburger = document.querySelector('.hamburger-menu');
        const navLinks = document.querySelector('.nav-links');
        const navLinksItems = document.querySelectorAll('.nav-links a');

        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navLinks.classList.toggle('active');
        });

        navLinksItems.forEach(link => {
            link.addEventListener('click', () => {
                hamburger.classList.remove('active');
                navLinks.classList.remove('active');
            });
        });

        // Navigation scroll behavior
        let lastScrollTop = 0;
        const nav = document.querySelector('nav');
        const scrollThreshold = 50;

        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            
            if (Math.abs(currentScroll - lastScrollTop) > scrollThreshold) {
                if (currentScroll > lastScrollTop && currentScroll > 100) {
                    nav.classList.add('nav-hidden');
                } else if (currentScroll < lastScrollTop) {
                    nav.classList.remove('nav-hidden');
                }
                lastScrollTop = currentScroll;
            }
        }, { passive: true });

        // Fonction pour basculer la visibilit√© du mot de passe
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const passwordIcon = document.getElementById('password-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                passwordIcon.textContent = 'üëÅÔ∏è';
            }
        }

        // Fonction pour valider le mot de passe
        function isPasswordValid(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password)
            };
            
            return Object.values(requirements).every(req => req);
        }

        // Fonction pour calculer la force du mot de passe
        function calculatePasswordStrength(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password)
            };

            // Compter les crit√®res remplis
            const fulfilledRequirements = Object.values(requirements).filter(req => req).length;
            
            if (fulfilledRequirements >= 3 && password.length >= 12) return 'strong';
            if (fulfilledRequirements >= 3) return 'good';
            if (fulfilledRequirements >= 2) return 'fair';
            return 'weak';
        }

        // Fonction pour mettre √† jour l'affichage des exigences (d√©sactiv√©e - on n'affiche plus les crit√®res)
        function updatePasswordRequirements(password) {
            // Fonction vide car on n'affiche plus les crit√®res
        }

        // Fonction pour mettre √† jour la barre de force
        function updatePasswordStrength(password) {
            const strengthFill = document.getElementById('strength-fill');
            const strengthText = document.getElementById('strength-text');
            
            if (!strengthFill || !strengthText) {
                console.log('‚ùå √âl√©ments de force du mot de passe non trouv√©s');
                return;
            }
            
            const strength = calculatePasswordStrength(password);
            console.log('üîê Force calcul√©e:', strength, 'pour', password.length, 'caract√®res');
            
            // Retirer toutes les classes de force
            strengthFill.classList.remove('weak', 'fair', 'good', 'strong');
            
            if (password.length === 0) {
                console.log('üîê Mot de passe vide - remise √† z√©ro de la barre');
                strengthFill.style.width = '0%';
                strengthFill.classList.remove('weak', 'fair', 'good', 'strong');
                strengthText.textContent = 'Force du mot de passe';
                return;
            }
            
            strengthFill.classList.add(strength);
            
            // Forcer la mise √† jour de la largeur selon la classe
            const widthMap = {
                weak: '25%',
                fair: '50%',
                good: '75%',
                strong: '100%'
            };
            
            strengthFill.style.width = widthMap[strength] || '0%';
            
            const strengthLabels = {
                weak: 'Faible',
                fair: 'Moyen',
                good: 'Bon',
                strong: 'Fort'
            };
            
            strengthText.textContent = strengthLabels[strength];
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            initStripe();

            const payButton = document.getElementById('pay-button');
            const payButtonText = document.getElementById('pay-button-text');
            if (payButton && payButtonText) {
                payButton.disabled = true;
                payButtonText.textContent = 'Chargement...';
            }

            updateQuantityUI();
            updatePayButtonState();

            loadEventData();

            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    console.log('üîê Mot de passe modifi√©:', password.length, 'caract√®res');
                    updatePasswordRequirements(password);
                    updatePasswordStrength(password);
                });
            } else {
                console.log('‚ùå Champ mot de passe non trouv√©');
            }
        });
    </script>
</body>
</html>
