<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billetterie BDB - Achetez vos tickets en ligne</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Achetez vos tickets d'événements étudiants à Bordeaux directement en ligne avec BDB. Paiement sécurisé, sans compte requis.">
    <meta name="keywords" content="billetterie étudiante Bordeaux, tickets événements étudiants, paiement en ligne, BDB">
    <meta name="author" content="BDB Team">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bureaudesbureaux.com/billetterie.html">
    <meta property="og:title" content="Billetterie BDB - Achetez vos tickets en ligne">
    <meta property="og:description" content="Achetez vos tickets d'événements étudiants à Bordeaux directement en ligne avec BDB. Paiement sécurisé, sans compte requis.">
    <meta property="og:image" content="https://bureaudesbureaux.com/Asset/og-image.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://bureaudesbureaux.com/billetterie.html">
    <meta property="twitter:title" content="Billetterie BDB - Achetez vos tickets en ligne">
    <meta property="twitter:description" content="Achetez vos tickets d'événements étudiants à Bordeaux directement en ligne avec BDB. Paiement sécurisé, sans compte requis.">
    <meta property="twitter:image" content="https://bureaudesbureaux.com/Asset/og-image.png">
    
    <!-- Canonical Link -->
    <link rel="canonical" href="https://bureaudesbureaux.com/billetterie.html">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/Asset/favicon.png">
    <link rel="apple-touch-icon" href="/Asset/apple-touch-icon.png">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Styles spécifiques à la billetterie -->
    <style>
        .billetterie-header {
            background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.5) 100%), url('Asset/Background.jpg') no-repeat center center/cover;
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 120px 2rem 4rem;
            border-radius: 20px;
            margin: 2rem auto 1rem;
            max-width: 1200px;
        }

        .billetterie-header h1 {
            font-size: 3.5rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .billetterie-header p {
            font-size: 1.3rem;
            color: var(--text-color);
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .cta-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        .events-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.25rem 2rem 4rem;
        }

        .events-section {
            margin-bottom: 4rem;
        }

        .events-section-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .events-section-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            text-align: left;
            margin: 0;
            letter-spacing: -0.03em;
        }

        .events-section-subtitle {
            text-align: left;
            color: rgba(255, 255, 255, 0.7);
            max-width: 520px;
            margin: 0;
        }

        .events-carousel {
            position: relative;
            margin-top: 2rem;
            padding-inline: 0;
        }

        .events-track {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            padding-bottom: 1.5rem;
            scroll-snap-type: x mandatory;
            mask-image: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,1) 4%, rgba(0,0,0,1) 96%, rgba(0,0,0,0));
            -webkit-mask-image: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,1) 4%, rgba(0,0,0,1) 96%, rgba(0,0,0,0));
        }

        .events-track::-webkit-scrollbar {
            height: 6px;
        }

        .events-track::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.15);
            border-radius: 999px;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.6);
            color: rgba(255,255,255,0.85);
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
            z-index: 2;
        }

        .carousel-button:hover {
            transform: translateY(-50%) scale(1.05);
            background: rgba(218,252,59,0.85);
            color: #050505;
        }

        .carousel-button:disabled {
            opacity: 0.35;
            pointer-events: none;
        }

        .carousel-button.prev {
            left: -0.75rem;
        }

        .carousel-button.next {
            right: -0.75rem;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid rgba(218,252,59,0.1);
            cursor: pointer;
            position: relative;
            min-height: 100%;
            flex: 0 0 clamp(260px, 28vw, 320px);
            scroll-snap-align: start;
        }

        .event-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
            z-index: -1;
        }

        .event-card:hover {
            transform: translateY(-10px);
            border-color: var(--accent-color);
            box-shadow: 0 10px 30px rgba(218,252,59,0.2);
        }

        .event-card:hover::after {
            opacity: 1;
        }

        .event-image {
            width: 100%;
            height: 180px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .event-price {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--accent-color);
            color: var(--background-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .event-content {
            padding: 1.25rem;
        }

        .event-title {
            color: var(--accent-color);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .event-date {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .event-location {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .event-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .buy-ticket-btn {
            width: 100%;
            padding: 1rem;
            background: transparent;
            border: 2px solid var(--accent-color);
            border-radius: 30px;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .buy-ticket-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--accent-color);
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.3s ease-out;
            z-index: 0;
        }

        .buy-ticket-btn:hover::before {
            transform: scaleX(1);
            transform-origin: left;
        }

        .buy-ticket-btn span {
            position: relative;
            z-index: 1;
        }

        .buy-ticket-btn:hover span {
            color: var(--background-color);
        }

        .event-card.past {
            opacity: 0.55;
            filter: grayscale(20%);
            transform: none;
        }

        .event-card.past:hover {
            opacity: 0.75;
            transform: translateY(-6px);
        }

        .event-card.past .event-price {
            background: rgba(218, 252, 59, 0.65);
        }

        .past-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.75);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 1rem;
        }

        .modal-open {
            overflow: hidden;
        }

        .event-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
            z-index: 1200;
        }

        .event-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .event-modal__content {
            background: rgba(12, 12, 12, 0.9);
            border: 1px solid rgba(218,252,59,0.15);
            border-radius: 24px;
            width: min(960px, calc(100% - 2rem));
            max-height: calc(100vh - 4rem);
            overflow: hidden;
            box-shadow: 0 40px 120px rgba(0,0,0,0.45);
            transform: translateY(40px) scale(0.96);
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
        }

        .event-modal.active .event-modal__content {
            transform: translateY(0) scale(1);
        }

        .event-modal__image {
            position: relative;
            overflow: hidden;
        }

        .event-modal__image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .event-modal__body {
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .event-modal__header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .event-modal__title {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .event-modal__info {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.95rem;
            color: rgba(255,255,255,0.75);
        }

        .event-modal__info-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.06);
        }

        .event-modal__info-item i {
            font-size: 0.95rem;
        }

        .event-modal__info-value {
            display: inline-block;
        }

        .event-modal__description {
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
            font-size: 1rem;
        }

        #event-map {
            width: 100%;
            height: 240px;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(218,252,59,0.1);
        }

        .event-modal__actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: auto;
        }

        .event-modal__buy {
            flex: 1;
            padding: 1rem 1.25rem;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--accent-color), rgba(218,252,59,0.8));
            color: #050505;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .event-modal__buy:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(218,252,59,0.25);
        }

        .event-modal__close {
            position: absolute;
            top: 1.2rem;
            right: 1.2rem;
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: none;
            background: rgba(0,0,0,0.6);
            color: rgba(255,255,255,0.85);
            font-size: 1.4rem;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: background 0.3s ease, transform 0.3s ease;
            z-index: 2;
        }

        .event-modal__close:hover {
            background: rgba(218,252,59,0.85);
            color: #050505;
            transform: rotate(90deg);
        }

        .event-modal__meta {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .event-modal__meta strong {
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .event-modal__meta span {
            font-size: 1.05rem;
            color: rgba(255,255,255,0.85);
        }

        .event-modal__status {
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.75);
            align-self: flex-start;
        }

        .event-modal__body strong.event-modal__meta-label {
            display: block;
            margin-bottom: 0.75rem;
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .event-modal__body #event-map {
            margin-top: 0.75rem;
        }

        .event-modal__status.past {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255,255,255,0.55);
        }

        @keyframes modalPulse {
            0% { transform: scale(0.96); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .event-modal.active .event-modal__image img {
            animation: modalPulse 0.45s ease both;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid var(--text-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .events-track .loading-spinner {
            display: block;
            margin: 1.5rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-events {
            text-align: center;
            padding: 4rem 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .no-events i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--accent-color);
        }

        @media (max-width: 768px) {
            .billetterie-header h1 {
                font-size: 2.5rem;
            }
            
            .billetterie-header p {
                font-size: 1.1rem;
            }
            
            .events-section-title {
                font-size: 2rem;
            }

            .events-container {
                padding: 1.5rem 1.25rem 3rem;
            }

            .events-carousel {
                padding-inline: 0;
            }

            .events-track {
                gap: 1rem;
                mask-image: none;
                overflow-x: auto;
            }

            .carousel-button {
                display: none;
            }

            .event-card {
                flex: 0 0 clamp(240px, 80vw, 300px);
            }

            .event-modal__content {
                grid-template-columns: 1fr;
                max-height: calc(100vh - 3rem);
            }

            .event-modal__image {
                height: 260px;
            }
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        .notification.success {
            background-color: #4CAF50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .notification.error {
            background-color: #f44336;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <div>
                <a href="index.html" class="brand-link">
                    <img src="Asset/Babylone 1024x1024.png" alt="BDB Logo" class="logo">
                    <span class="brand-name">BDB</span>
                </a>
            </div>
            <button class="hamburger-menu" aria-label="Menu" aria-expanded="false" aria-controls="nav-links">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links" id="nav-links" role="navigation" aria-label="Menu principal">
                <a href="index.html">Accueil</a>
                <a href="index.html#fonctionnalites">Fonctionnalités</a>
                <a href="index.html#how-it-works">Comment ça marche</a>
                <a href="index.html#evenements">Événements</a>
                <a href="billetterie.html">Billetterie</a>
                <a href="index.html#contact">Contact</a>
                <a href="blog.html">Blog</a>
            </div>
        </div>
    </nav>

    <header class="billetterie-header">
        <div data-aos="fade-up">
            <h1>Billetterie BDB</h1>
            <p>Achetez vos tickets d'événements étudiants directement en ligne</p>
            <div class="cta-buttons">
                <a href="#events" class="cta-button" aria-label="Voir les événements disponibles">
                    <span>Voir les événements</span>
                </a>
            </div>
        </div>
    </header>

    <main class="events-container">
        <!-- Événements à venir -->
        <section id="events" class="events-section" data-aos="fade-up">
            <div class="events-section-header">
                <h2 class="events-section-title">Évènements à venir</h2>
                <p class="events-section-subtitle">Ne manquez pas les prochaines soirées et expériences étudiantes sélectionnées par BDB.</p>
            </div>
            <div class="events-carousel" data-carousel="upcoming">
                <button class="carousel-button prev" type="button" aria-label="Faire défiler les événements précédents">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="events-grid" class="events-track" role="list">
                    <div class="loading-spinner" id="loading-spinner"></div>
                </div>
                <button class="carousel-button next" type="button" aria-label="Faire défiler les événements suivants">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div id="no-events" class="no-events" style="display: none;">
                <i class="fas fa-calendar-times"></i>
                <h3>Aucun événement trouvé</h3>
                <p>Il n'y a pas d'événements disponibles pour le moment.</p>
            </div>
        </section>

        <!-- Événements passés -->
        <section id="past-events" class="events-section" data-aos="fade-up">
            <div class="events-section-header">
                <h2 class="events-section-title">Évènements passés</h2>
                <p class="events-section-subtitle">Revivez les moments forts et découvrez l'ambiance des dernières éditions.</p>
            </div>
            <div class="events-carousel" data-carousel="past">
                <button class="carousel-button prev" type="button" aria-label="Faire défiler les événements passés précédents">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="past-events-grid" class="events-track" role="list"></div>
                <button class="carousel-button next" type="button" aria-label="Faire défiler les événements passés suivants">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div id="no-past-events" class="no-events" style="display: none;">
                <i class="fas fa-hourglass-end"></i>
                <h3>Aucun événement passé</h3>
                <p>Dès que des événements seront terminés, vous pourrez les retrouver ici.</p>
            </div>
        </section>
    </main>

    <div id="event-modal" class="event-modal" aria-hidden="true">
        <div class="event-modal__content" role="dialog" aria-modal="true" aria-labelledby="event-modal-title">
            <button class="event-modal__close" type="button" aria-label="Fermer la fenêtre">&times;</button>
            <div class="event-modal__image">
                <img id="event-modal-image" src="" alt="Illustration de l'événement">
            </div>
            <div class="event-modal__body">
                <div class="event-modal__header">
                    <span id="event-modal-status" class="event-modal__status" hidden></span>
                    <h3 id="event-modal-title" class="event-modal__title"></h3>
                    <div class="event-modal__info">
                        <div id="event-modal-date" class="event-modal__info-item">
                            <i class="fas fa-calendar-day"></i>
                            <span class="event-modal__info-value"></span>
                        </div>
                        <div id="event-modal-time" class="event-modal__info-item">
                            <i class="fas fa-clock"></i>
                            <span class="event-modal__info-value"></span>
                        </div>
                        <div id="event-modal-location" class="event-modal__info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span class="event-modal__info-value"></span>
                        </div>
                    </div>
                </div>
                <div class="event-modal__description" id="event-modal-description"></div>
                <div class="event-modal__meta">
                    <div>
                        <strong>Organisé par</strong>
                        <span id="event-modal-association"></span>
                    </div>
                    <div>
                        <strong>Tarif</strong>
                        <span id="event-modal-price"></span>
                    </div>
                </div>
                <div>
                    <strong class="event-modal__meta-label">Localisation</strong>
                    <div id="event-map"></div>
                </div>
                <div class="event-modal__actions">
                    <button id="event-modal-buy" class="event-modal__buy" type="button">Acheter un ticket</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="legal-links">
                <a href="politique-confidentialite.html" target="_blank">Politique de confidentialité</a>
                <a href="conditions-utilisation.html" target="_blank">Conditions d'utilisation</a>
                <a href="blog.html">Blog</a>
            </div>
        </div>
        <p class="copyright">© 2024 BDB. Tous droits réservés.</p>
    </footer>

    <div id="notification" class="notification"></div>

    <script>
        // Menu hamburger
        const hamburger = document.querySelector('.hamburger-menu');
        const navLinks = document.querySelector('.nav-links');
        const navLinksItems = document.querySelectorAll('.nav-links a');

        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navLinks.classList.toggle('active');
        });

        // Fermer le menu quand on clique sur un lien
        navLinksItems.forEach(link => {
            link.addEventListener('click', () => {
                hamburger.classList.remove('active');
                navLinks.classList.remove('active');
            });
        });

        // Navigation scroll behavior
        let lastScrollTop = 0;
        const nav = document.querySelector('nav');
        const scrollThreshold = 50;

        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            
            if (Math.abs(currentScroll - lastScrollTop) > scrollThreshold) {
                if (currentScroll > lastScrollTop && currentScroll > 100) {
                    nav.classList.add('nav-hidden');
                } else if (currentScroll < lastScrollTop) {
                    nav.classList.remove('nav-hidden');
                }
                lastScrollTop = currentScroll;
            }
        }, { passive: true });

        // Variables globales
        let allEvents = [];
        let activeEvent = null;
        let mapsReady = false;
        let mapInstance = null;
        let mapMarker = null;
        let geocoder = null;
        let pendingMapEvent = null;

        const modalElement = document.getElementById('event-modal');
        const modalCloseButton = modalElement.querySelector('.event-modal__close');
        const modalImage = document.getElementById('event-modal-image');
        const modalTitle = document.getElementById('event-modal-title');
        const modalDescription = document.getElementById('event-modal-description');
        const modalAssociation = document.getElementById('event-modal-association');
        const modalPrice = document.getElementById('event-modal-price');
        const modalStatus = document.getElementById('event-modal-status');
        const modalBuyButton = document.getElementById('event-modal-buy');
        const modalDateWrapper = document.getElementById('event-modal-date');
        const modalTimeWrapper = document.getElementById('event-modal-time');
        const modalLocationWrapper = document.getElementById('event-modal-location');
        const modalDateValue = modalDateWrapper ? modalDateWrapper.querySelector('.event-modal__info-value') : null;
        const modalTimeValue = modalTimeWrapper ? modalTimeWrapper.querySelector('.event-modal__info-value') : null;
        const modalLocationValue = modalLocationWrapper ? modalLocationWrapper.querySelector('.event-modal__info-value') : null;

        const carouselRegistry = new WeakMap();

        const mapFallbackCenter = { lat: 44.837789, lng: -0.57918 };
        const mapStyles = [
            { elementType: 'geometry', stylers: [{ color: '#1f1f1f' }] },
            { elementType: 'labels.text.fill', stylers: [{ color: '#f6f6f6' }] },
            { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a1a' }] },
            {
                featureType: 'poi',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#a0a0a0' }]
            },
            {
                featureType: 'poi.park',
                elementType: 'geometry',
                stylers: [{ color: '#1b2a1b' }]
            },
            {
                featureType: 'road',
                elementType: 'geometry',
                stylers: [{ color: '#2a2a2a' }]
            },
            {
                featureType: 'road',
                elementType: 'geometry.stroke',
                stylers: [{ color: '#121212' }]
            },
            {
                featureType: 'road.highway',
                elementType: 'geometry',
                stylers: [{ color: '#444444' }]
            },
            {
                featureType: 'water',
                elementType: 'geometry',
                stylers: [{ color: '#0c1f33' }]
            }
        ];

        function initCarousel(carouselElement) {
            if (!carouselElement) {
                return;
            }

            const track = carouselElement.querySelector('.events-track');
            if (!track) {
                return;
            }

            const prevButton = carouselElement.querySelector('.carousel-button.prev');
            const nextButton = carouselElement.querySelector('.carousel-button.next');

            const updateButtons = () => {
                const maxScrollLeft = Math.max(track.scrollWidth - track.clientWidth - 2, 0);
                if (prevButton) {
                    prevButton.disabled = track.scrollLeft <= 0;
                }
                if (nextButton) {
                    nextButton.disabled = track.scrollLeft >= maxScrollLeft;
                }
            };

            const scrollByAmount = (direction) => {
                const offset = track.clientWidth * 0.8;
                track.scrollBy({
                    left: direction * offset,
                    behavior: 'smooth'
                });
            };

            if (!carouselRegistry.has(carouselElement)) {
                if (prevButton) {
                    prevButton.addEventListener('click', () => scrollByAmount(-1));
                }
                if (nextButton) {
                    nextButton.addEventListener('click', () => scrollByAmount(1));
                }

                const onScroll = () => requestAnimationFrame(updateButtons);
                track.addEventListener('scroll', onScroll, { passive: true });
                window.addEventListener('resize', onScroll);

                carouselRegistry.set(carouselElement, {
                    update: updateButtons
                });
            }

            requestAnimationFrame(updateButtons);
        }

        function refreshCarousels() {
            document.querySelectorAll('.events-carousel').forEach(initCarousel);
        }

        // Fonction pour afficher les notifications
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;

            notification.offsetHeight;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function parseEventDate(dateString) {
            if (!dateString) {
                return null;
            }
            const date = new Date(dateString);
            return Number.isNaN(date.getTime()) ? null : date;
        }

        function formatEventDate(date) {
            if (!(date instanceof Date)) {
                return '';
            }
            return date.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatEventTime(date) {
            if (!(date instanceof Date)) {
                return '';
            }
            return date.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatEventPriceBadge(value) {
            const price = Number(value);
            if (!Number.isFinite(price) || price <= 0) {
                return 'Gratuit';
            }
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                maximumFractionDigits: price % 1 === 0 ? 0 : 2
            }).format(price);
        }

        function formatEventPrice(value) {
            const price = Number(value);
            if (!Number.isFinite(price) || price <= 0) {
                return 'Gratuit';
            }
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(price);
        }

        function createEventCard(event, isPast = false) {
            const eventDate = parseEventDate(event.date);
            const formattedDate = eventDate ? formatEventDate(eventDate) : 'Date à venir';
            const formattedTime = eventDate ? formatEventTime(eventDate) : '';
            const description = event.description || 'Un événement à ne pas manquer !';
            const priceBadge = formatEventPriceBadge(event.price);
            const imageUrl = event.image_url || 'Asset/EventPhare 01.png';

            return `
                <article class="event-card${isPast ? ' past' : ''}" data-event-id="${event.id}" tabindex="0" data-aos="fade-up" role="listitem">
                    <div class="event-image" style="background-image: url('${imageUrl}')">
                        <div class="event-price">${priceBadge}</div>
                    </div>
                    <div class="event-content">
                        ${isPast ? '<div class="past-badge"><i class="fas fa-check-circle"></i>Évènement terminé</div>' : ''}
                        <h3 class="event-title">${event.name}</h3>
                        <div class="event-date">
                            <i class="fas fa-calendar-alt"></i>
                            ${formattedDate}${formattedTime ? ` · ${formattedTime}` : ''}
                        </div>
                        <div class="event-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${event.address || event.location || 'Lieu annoncé bientôt'}
                        </div>
                        <p class="event-description">${description}</p>
                        ${!isPast ? `
                            <button class="buy-ticket-btn" type="button" data-event-id="${event.id}">
                                <span>Acheter un ticket</span>
                            </button>
                        ` : ''}
                    </div>
                </article>
            `;
        }

        function attachEventInteractions(container) {
            if (!container) {
                return;
            }

            container.querySelectorAll('.event-card').forEach(card => {
                const eventId = card.dataset.eventId;
                card.addEventListener('click', (evt) => {
                    if (evt.target.closest('.buy-ticket-btn')) {
                        return;
                    }
                    openEventModalById(eventId);
                });

                card.addEventListener('keydown', (evt) => {
                    if (evt.key === 'Enter' || evt.key === ' ') {
                        evt.preventDefault();
                        openEventModalById(eventId);
                    }
                });
            });

            container.querySelectorAll('.buy-ticket-btn').forEach(button => {
                button.addEventListener('click', (evt) => {
                    evt.stopPropagation();
                    const eventId = button.dataset.eventId;
                    buyTicket(eventId);
                });
            });
        }

        function openEventModalById(eventId) {
            const event = allEvents.find(item => String(item.id) === String(eventId));
            if (!event) {
                showNotification('Événement introuvable', 'error');
                return;
            }
            openEventModal(event);
        }

        function openEventModal(event) {
            const eventDate = parseEventDate(event.date);
            const isPast = eventDate ? eventDate < new Date() : false;

            activeEvent = event;

            modalImage.src = event.image_url || 'Asset/EventPhare 01.png';
            modalImage.alt = `Illustration de l'événement ${event.name}`;
            modalTitle.textContent = event.name;
            if (modalDateValue) {
                modalDateValue.textContent = eventDate ? formatEventDate(eventDate) : 'Date à confirmer';
            }
            if (modalTimeValue) {
                modalTimeValue.textContent = eventDate ? formatEventTime(eventDate) : '';
            }
            if (modalLocationValue) {
                modalLocationValue.textContent = event.address || event.location || 'Lieu communiqué prochainement';
            }
            modalDescription.textContent = event.description || 'Un événement à ne pas manquer !';
            modalAssociation.textContent = event.association_name || 'Association BDB';
            modalPrice.textContent = formatEventPrice(event.price);

            if (modalDateWrapper) {
                const hasDateValue = modalDateValue && modalDateValue.textContent;
                modalDateWrapper.style.display = hasDateValue ? 'inline-flex' : 'none';
            }
            if (modalTimeWrapper) {
                const hasTimeValue = modalTimeValue && modalTimeValue.textContent;
                modalTimeWrapper.style.display = hasTimeValue ? 'inline-flex' : 'none';
            }
            if (modalLocationWrapper) {
                const hasLocationValue = modalLocationValue && modalLocationValue.textContent;
                modalLocationWrapper.style.display = hasLocationValue ? 'inline-flex' : 'none';
            }

            if (isPast) {
                modalStatus.textContent = 'Évènement passé';
                modalStatus.classList.add('past');
                modalStatus.hidden = false;
                modalBuyButton.style.display = 'none';
            } else {
                modalStatus.textContent = 'Évènement à venir';
                modalStatus.classList.remove('past');
                modalStatus.hidden = false;
                modalBuyButton.style.display = 'inline-flex';
            }

            modalElement.classList.add('active');
            document.body.classList.add('modal-open');

            setTimeout(() => {
                if (mapInstance) {
                    google.maps.event.trigger(mapInstance, 'resize');
                }
                renderEventMap(event);
            }, 200);
        }

        function closeEventModal() {
            modalElement.classList.remove('active');
            document.body.classList.remove('modal-open');
            activeEvent = null;
        }

        modalCloseButton.addEventListener('click', closeEventModal);
        modalElement.addEventListener('click', (evt) => {
            if (evt.target === modalElement) {
                closeEventModal();
            }
        });

        document.addEventListener('keydown', (evt) => {
            if (evt.key === 'Escape' && modalElement.classList.contains('active')) {
                closeEventModal();
            }
        });

        modalBuyButton.addEventListener('click', () => {
            if (activeEvent) {
                buyTicket(activeEvent.id);
            }
        });

        function initialiseMapIfNeeded() {
            if (mapInstance) {
                return;
            }
            const mapElement = document.getElementById('event-map');
            if (!mapElement || !mapsReady || typeof google === 'undefined') {
                return;
            }

            geocoder = new google.maps.Geocoder();
            mapInstance = new google.maps.Map(mapElement, {
                center: mapFallbackCenter,
                zoom: 12,
                disableDefaultUI: true,
                styles: mapStyles
            });
        }

        function renderEventMap(event) {
            if (!event || !mapsReady) {
                pendingMapEvent = event;
                return;
            }

            initialiseMapIfNeeded();

            if (!mapInstance || !geocoder) {
                pendingMapEvent = event;
                return;
            }

            const address = event.address || event.location;
            if (!address) {
                mapInstance.setCenter(mapFallbackCenter);
                mapInstance.setZoom(12);
                return;
            }

            geocoder.geocode({ address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const position = results[0].geometry.location;
                    mapInstance.setCenter(position);
                    mapInstance.setZoom(14);

                    if (mapMarker) {
                        mapMarker.setMap(null);
                    }

                    mapMarker = new google.maps.Marker({
                        map: mapInstance,
                        position,
                        title: event.name
                    });
                } else {
                    console.warn('Geocode non concluante:', status);
                    mapInstance.setCenter(mapFallbackCenter);
                    mapInstance.setZoom(12);
                }
            });
        }

        window.initEventMap = function initEventMap() {
            mapsReady = true;
            initialiseMapIfNeeded();
            if (pendingMapEvent) {
                renderEventMap(pendingMapEvent);
                pendingMapEvent = null;
            }
        };

        // Fonction pour charger les événements
        async function loadEvents() {
            const eventsGrid = document.getElementById('events-grid');
            const pastEventsGrid = document.getElementById('past-events-grid');
            const noEvents = document.getElementById('no-events');
            const noPastEvents = document.getElementById('no-past-events');

            let loadingSpinner = null;
            if (eventsGrid) {
                eventsGrid.innerHTML = '';
                loadingSpinner = document.createElement('div');
                loadingSpinner.className = 'loading-spinner';
                eventsGrid.appendChild(loadingSpinner);
            }

            try {
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'block';
                }

                const response = await fetch('/.netlify/functions/getEvents');
                const data = await response.json();

                if (response.ok) {
                    allEvents = data.events || [];
                    displayEvents(allEvents);
                } else {
                    throw new Error(data.error || 'Erreur lors du chargement des événements');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors du chargement des événements', 'error');
                if (eventsGrid) {
                    eventsGrid.innerHTML = '';
                }
                if (pastEventsGrid) {
                    pastEventsGrid.innerHTML = '';
                }
                if (noEvents) {
                    noEvents.style.display = 'block';
                }
                if (noPastEvents) {
                    noPastEvents.style.display = 'block';
                }
                refreshCarousels();
            } finally {
                if (loadingSpinner && loadingSpinner.parentNode) {
                    loadingSpinner.parentNode.removeChild(loadingSpinner);
                }
            }
        }

        // Fonction pour afficher les événements
        function displayEvents(events = []) {
            const eventsGrid = document.getElementById('events-grid');
            const pastEventsGrid = document.getElementById('past-events-grid');
            const noEvents = document.getElementById('no-events');
            const noPastEvents = document.getElementById('no-past-events');

            if (!eventsGrid || !pastEventsGrid) {
                return;
            }

            if (!Array.isArray(events) || events.length === 0) {
                eventsGrid.innerHTML = '';
                pastEventsGrid.innerHTML = '';
                if (noEvents) noEvents.style.display = 'block';
                if (noPastEvents) noPastEvents.style.display = 'block';
                refreshCarousels();
                return;
            }

            const now = new Date();
            const upcomingEvents = [];
            const pastEvents = [];

            events.forEach(event => {
                const eventDate = parseEventDate(event.date);
                if (eventDate && eventDate < now) {
                    pastEvents.push(event);
                } else {
                    upcomingEvents.push(event);
                }
            });

            upcomingEvents.sort((a, b) => {
                const dateA = parseEventDate(a.date) || new Date();
                const dateB = parseEventDate(b.date) || new Date();
                return dateA - dateB;
            });

            pastEvents.sort((a, b) => {
                const dateA = parseEventDate(a.date) || new Date(0);
                const dateB = parseEventDate(b.date) || new Date(0);
                return dateB - dateA;
            });

            eventsGrid.innerHTML = upcomingEvents.map(event => createEventCard(event, false)).join('');
            pastEventsGrid.innerHTML = pastEvents.map(event => createEventCard(event, true)).join('');

            if (noEvents) {
                noEvents.style.display = upcomingEvents.length ? 'none' : 'block';
            }

            if (noPastEvents) {
                noPastEvents.style.display = pastEvents.length ? 'none' : 'block';
            }

            attachEventInteractions(eventsGrid);
            attachEventInteractions(pastEventsGrid);

            refreshCarousels();

            if (window.AOS && typeof window.AOS.refreshHard === 'function') {
                window.AOS.refreshHard();
            }
        }

        // Fonction pour acheter un ticket
        function buyTicket(eventId) {
            const event = allEvents.find(e => String(e.id) === String(eventId));
            if (!event) {
                showNotification('Événement introuvable', 'error');
                return;
            }

            window.location.href = `paiement.html?id=${eventId}`;
        }

        // Charger les événements au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            refreshCarousels();

            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true
            });
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCOrw2XWhogK99BWNSZ1brDXqGuFOAW8c&callback=initEventMap"></script>
</body>
</html>
